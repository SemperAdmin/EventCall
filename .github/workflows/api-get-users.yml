name: API - Get Users

on:
  repository_dispatch:
    types: [get_users]
  schedule:
    - cron: '*/10 * * * *'  # Run every 10 minutes to sync users

env:
  GITHUB_OWNER: SemperAdmin
  DATA_REPO: EventCall-Data

jobs:
  sync-users:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Users from Private Repo
        id: fetch
        run: |
          echo "Fetching users from private repo..."

          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.EVENTCALL_MANAGER_TOKEN }}" \
            "https://api.github.com/repos/${{ env.GITHUB_OWNER }}/${{ env.DATA_REPO }}/contents/users")

          if [ $? -ne 0 ]; then
            echo "Failed to fetch users directory"
            echo "[]" > combined-users.json
            exit 0
          fi

          echo "$RESPONSE" > users-list.json

          # Initialize empty array
          echo "[]" > all-users.json

          # Fetch each user file
          for url in $(echo "$RESPONSE" | jq -r '.[] | select(.name | endswith(".json")) | .url'); do
            echo "Fetching: $url"
            USER_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.EVENTCALL_MANAGER_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" "$url")

            # Decode base64 content
            USER_DATA=$(echo "$USER_RESPONSE" | jq -r '.content' | base64 -d)
            echo "$USER_DATA" >> all-users.json
          done

          # Combine into array
          jq -s '.' all-users.json > combined-users.json

          echo "Fetched $(jq length combined-users.json) users"

      - name: Save to Public Repo for Frontend Access
        run: |
          CONTENT=$(base64 -w 0 combined-users.json)

          # Get current file SHA if it exists
          SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/contents/users-index.json" \
            | jq -r '.sha // empty')

          # Prepare request body
          if [ -z "$SHA" ]; then
            BODY="{\"message\":\"Update users index\",\"content\":\"$CONTENT\"}"
          else
            BODY="{\"message\":\"Update users index\",\"content\":\"$CONTENT\",\"sha\":\"$SHA\"}"
          fi

          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/contents/users-index.json \
            -d "$BODY"

          echo "Users index updated"
